[
  {
    "name": "From Kindle to Gmail!",
    "handle": "highlights",
    "date": "2025-12-14",
    "body_html": "<h1>From Kindle to Gmail: Building My Own Readwise-Like System on AWS</h1>\n<p>I've always adored <strong>Readwise</strong> the app resurfacing your book highlights so they stick. </p>\n<p><strong>The Magic Result:</strong> Pure automation joy! Every day 5 random highlights in to my mailbox.</p>\n<h3>The Journey: Practicing AWS, and Linux to Event-Driven Automation</h3>\n<p>Roadmap <strong>Kindle → Ubuntu → S3 → Lambda → Email</strong>.</p>\n<ol>\n<li>Write sync_kindle.sh, schedule with udev,</li>\n<li>Install AWS CLI, configure with IAM keys.</li>\n<li>Create S3 bucket, test upload.</li>\n<li>Write lambda_function.py, zip, create Lambda with IAM role (AWSLambdaBasicExecutionRole, AmazonS3ReadOnlyAccess, AmazonSNSFullAccess).</li>\n<li>Set CloudWatch rule, link to Lambda.</li>\n<li>Create SNS topic, subscribe email, update Lambda to publish.</li>\n<li>Test: aws lambda invoke ..., check email.</li>\n</ol>\n<p><strong>Version 1 (Cron + Daily):</strong> Script polled every 5 mins.</p>\n<p>In the first project I used cron:</p>\n<p><code>bash\ncrontab -e\n*/5 * * * * ~/kindle_highlights/sync_kindle.sh</code>\nBut what I wanted to try is a different way. To get synchronization only when the Kindle is plugged. the udev is ideal for it.</p>\n<p><strong>Version 2 (mount trigged):</strong> Switched to <strong>udev</strong> for event-driven trigger on plug-in. </p>\n<h3>Deep Dive: How It Works</h3>\n<ol>\n<li><strong>Instant Trigger: udev Detects Kindle Plug-In</strong></li>\n<li>Ubuntu auto-mounts at <code>/media/$USER/Kindle</code>.</li>\n<li>udev runs script <strong>once</strong> when partition appears.</li>\n</ol>\n<p><strong>Discovery Commands</strong>\n   <code>bash\n   lsblk                  # Spot the Kindle mount\n   lsusb                  # Find \"1949:xxxx\" (Amazon vendor ID)\n   lsusb -v | grep -E 'idVendor|idProduct'  # Detailed IDs\n   udevadm monitor --environment --udev    # Live debug events</code></p>\n<p><strong>hint</strong>: amazon kindle division is Lab126 and their official vendor is 1949, it’s easier when you know what you are searching for.</p>\n<p><strong>hint</strong>: check if the Kindle is mounted, because I have only charged cables as well, these cannot transfer data.</p>\n<p><strong>udev Rule</strong>\n   <code>bash\n   sudo nano /etc/udev/rules.d/99-kindle-sync.rules</code>\n   <code>ACTION==\"add\", SUBSYSTEM==\"block\", ENV{ID_VENDOR_ID}==\"1949\", ENV{ID_MODEL_ID}==\"0324\", \\\n     ENV{ID_FS_USAGE}==\"filesystem\", ENV{ID_FS_TYPE}==\"vfat\", ENV{DEVTYPE}==\"partition\", \\\n     RUN+=\"/bin/bash /home/$USER/kindle_highlights/run_sync_when_kindle_arrives.sh\"</code>\n   Reload:\n   <code>bash\n   sudo udevadm control --reload-rules &amp;&amp; sudo udevadm trigger</code></p>\n<ol>\n<li><strong>Wrapper &amp; Main Script</strong>\n   Wrapper for udev iscreated to simplify the execution of specific action when certain device events occur:</li>\n</ol>\n<p><code>bash\n   # ~/kindle_highlights/run_sync_when_kindle_arrives.sh\n   #!/bin/bash\n   exec sudo -u $USER /bin/bash /home/$USER/kindle_highlights/sync_kindle.sh \\\n     &gt;&gt; /home/$USER/kindle_highlights/sync_log.txt 2&gt;&amp;1</code></p>\n<p>Main script:</p>\n<p>```bash\n    #!/bin/bash\n    set -euo pipefail</p>\n<pre><code>KINDLE_MOUNT=\"/media/wolsky/Kindle\"\nSOURCE=\"${KINDLE_MOUNT}/documents/My Clippings.txt\"\nDEST_DIR=\"/home/wolsky/kindle_highlights\"\nTIMESTAMP=$(date +%Y%m%d_%H%M%S)\n\nDEST=\"${DEST_DIR}/My_Clippings_${TIMESTAMP}.txt\"          # Raw history\nLOG=\"${DEST_DIR}/sync_log.txt\"\n\n\nS3_KEY=\"My Clippings.txt\"\nS3_BUCKET=\"s3://wolsky-cytaty\"\n\nlog() {\n    echo \"[$(date '+%Y-%m-%d %H:%M:%S')] $*\" &gt;&gt; \"$LOG\";\n}\n\n# Prevent double execution\n[[ -f \"$DEST_DIR/.sync.lock\" ]] &amp;&amp; exit 0\ntouch \"$DEST_DIR/.sync.lock\"\ntrap 'rm -f \"$DEST_DIR/.sync.lock\"' EXIT\n\nif [[ -f \"$SOURCE\" ]]; then\n    # Raw backup\n    cp \"$SOURCE\" \"$DEST\"\n    log \"Saved raw copy: $DEST\"\n\n    # Clean and upload\n    CLEANED=\"${DEST_DIR}/My_Clippings_clean.txt\"\n    if ~/kindle_highlights/clean_clippings.py \"$SOURCE\" \"$CLEANED\"; then\n        log \"Successfully cleaned clippings\"\n\n        if aws s3 cp \"$CLEANED\" \"${S3_BUCKET}/${S3_KEY}\" --only-show-errors; then\n            log \"Uploaded cleaned version → Lambda will send polished highlights\"\n        else\n            log \"S3 upload failed (cleaned file)\"\n        fi\n    else\n        log \"Cleaning failed — uploading raw version as fallback\"\n        aws s3 cp \"$SOURCE\" \"${S3_BUCKET}/${S3_KEY}\" --only-show-errors &amp;&amp; \\\n        log \"Uploaded raw version\"\n    fi\nelse\n    log \"Kindle not mounted or My Clippings.txt not found\"\nfi\n```\n</code></pre>\n<h3>Bonus: Clean Highlights</h3>\n<p>Remove short/empty ones:</p>\n<p>```python</p>\n<h1>~/kindle_highlights/clean_clippings.py</h1>\n<h1>!/usr/bin/env python3</h1>\n<p>from pathlib import Path</p>\n<p>def clean(input_path, output_path):\n    content = input_path.read_text(encoding='utf-8')\n    entries = [e.strip() for e in content.split('==========') if e.strip()]\n    cleaned = []\n    for entry in entries:\n        lines = [l.strip() for l in entry.splitlines() if l.strip()]\n        if len(lines) &lt; 3: continue\n        text = ' '.join(lines[2:]).strip()\n        if len(text) &lt; 15: continue\n        cleaned.append('\\n'.join(lines) + '\\n==========\\n')\n    output_path.write_text(''.join(cleaned), encoding='utf-8')</p>\n<p>if <strong>name</strong> == '<strong>main</strong>':\n    clean(Path(sys.argv[1]), Path(sys.argv[2]))\n```\n3. Install AWS CLI on Ubuntu\nInstalled AWS CLI manually since apt failed.</p>\n<p><code>bash\nsudo apt update &amp;&amp; sudo apt install -y unzip curl\ncurl \"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\" -o \"awscliv2.zip\"\nunzip awscliv2.zip\nsudo ./aws/install\naws --version\nrm -rf awscliv2.zip aws</code></p>\n<p><strong>Crucial</strong>: Configured credentials:</p>\n<p>```bash</p>\n<p>aws configure</p>\n<h1>Access Key ID: [from IAM]</h1>\n<h1>Secret Access Key: [from IAM]</h1>\n<h1>Region: us-east-1</h1>\n<h1>Output: json</h1>\n<p>```</p>\n<h2><strong>Cloud Flow: S3 → Lambda → SNS</strong></h2>\n<pre><code>Architecture:\n![System diagram](/images/blog/my-post/AWS draw.png)\n</code></pre>\n<ol>\n<li>Set Up S3 Bucket</li>\n</ol>\n<p>Created wolsky-cytaty bucket \n<code>bash\naws s3 mb s3://wolsky-cytaty/ --region us-east-1</code></p>\n<ol>\n<li>Create Lambda Function\nWrote lambda_function.py to pick 5 highlights.\n```python\nimport boto3\nimport random</li>\n</ol>\n<p>s3 = boto3.client('s3')\nsns = boto3.client('sns')</p>\n<p>def lambda_handler(event, context):\n    bucket = 'wolsky-cytaty'\n    key = 'My Clippings.txt'\n    obj = s3.get_object(Bucket=bucket, Key=key)\n    content = obj['Body'].read().decode('utf-8')\n    highlights = [h.strip() for h in content.split('==========') if h.strip()]\n    five = random.sample(highlights, k=min(5, len(highlights)))\n    message = '\\n\\n'.join(five)</p>\n<pre><code>sns.publish(\n    TopicArn='arn:aws:sns:us-east-1:123456789:DailyHighlights',\n    Message=message,\n    Subject='Do you remember this?'\n)\n</code></pre>\n<p>```</p>\n<ol>\n<li>Lambda</li>\n</ol>\n<p>Every service in the automations needs a Lambda ARN.</p>\n<ul>\n<li>CloudWatch Events needs a target</li>\n<li>Permissions need a function name</li>\n<li>Testing needs a deployed function</li>\n</ul>\n<p><code>bash\naws lambda create-function \\\n  --function-name sendRandomHighlight \\\n  --runtime python3.13 \\\n  --handler lambda_function.lambda_handler \\\n  --role arn:aws:iam::YOUR_ACCOUNT_ID:role/lambda-s3-role \\\n  --zip-file fileb://function.zip</code>\n- Create = define infrastructure\n- Update = iterate on logic</p>\n<p><code>bash\naws lambda update-function-code --function-name sendRandomHighlight --zip-file fileb://function.zip</code></p>\n<ol>\n<li>\n<p>Test:\n<code>bash\naws lambda invoke --function-name sendRandomHighlight --payload '{}' output.json.</code></p>\n</li>\n<li>\n<p>: Schedule with CloudWatch</p>\n</li>\n</ol>\n<p>What: Set daily trigger.</p>\n<p><code>bash\naws events put-rule --name DailyHighlightTrigger --schedule-expression 'rate(1 day)'</code>\n<code>bash\naws lambda add-permission \\\n  --function-name sendRandomHighlight \\\n  --statement-id CloudWatchTrigger \\\n  --action 'lambda:InvokeFunction' \\\n  --principal events.amazonaws.com \\\n  --source-arn arn:aws:events:us-east-1:YOUR_ACCOUNT_ID:rule/DailyHighlightTrigger</code>\n<code>bash\naws events put-targets \\\n  --rule DailyHighlightTrigger \\\n  --targets '[{\"Id\": \"1\", \"Arn\": \"arn:aws:lambda:us-east-1:YOUR_ACCOUNT_ID:function:sendRandomHighlight\"}]'</code></p>\n<ol>\n<li>Set Up SNS for Email</li>\n</ol>\n<p>What: Added email notifications.</p>\n<p>```bash\naws sns subscribe \\\n  --topic-arn arn:aws:sns:us-east-1:YOUR_ACCOUNT_ID:DailyHighlights \\\n  --protocol email \\\n  --notification-endpoint your_email@gmail.com</p>\n<p>This project taught Linux automation, event-driven design, and cloud basics. </p>"
  },
  {
    "name": "Hello Mars!",
    "handle": "hello-mars",
    "date": "2025-12-07",
    "body_html": "<h1>Hello Mars!</h1>\n<p>This is my <strong>first</strong> blog post. More is coming soon!</p>"
  }
]