- name: Build and deploy frontend to S3
  hosts: localhost
  gather_facts: false
  collections: 
    - community.aws

  vars_files:
  - vaults/prod.yml

  vars:
    bucket_name: 'www.kamilwolczynskiresume.com'
    project_root: "{{ playbook_dir | realpath }}/../.."
    build_dir: "{{ frontend_dir }}/dist" 
    frontend_dir: "{{ project_root }}/frontend"

   
  tasks:

    - name: Install frontend dependencies
      command: npm ci
      args:
        chdir: "{{ frontend_dir }}"

    - name: Build frontend
      command: npm run build-aws
      args:
        chdir: "{{ frontend_dir }}"

    - name: Ensure build directory exists
      stat:
        path: "{{ build_dir }}"
      register: build_stat

    - name: Fail if build directory missing
      fail:
        msg: "Build directory not found. Vite build failed."
      when: not build_stat.stat.exists

    - name: Upload build to S3
      community.aws.s3_sync:
        bucket: "{{ bucket_name }}"
        file_root: "{{ build_dir }}"
        aws_access_key: "{{ AWS_ACCESS_KEY_ID }}"
        aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
        region: "{{ AWS_REGION }}"
        delete: true

    - name: Upload index.html with no-store (SPA routing)
      amazon.aws.s3_object:
        bucket: "{{ bucket_name }}"
        aws_access_key: "{{ AWS_ACCESS_KEY_ID }}"
        aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
        region: "{{ AWS_REGION }}"
        object: "index.html"
        src: "{{ build_dir }}/index.html"
        mode: put
        metadata:
          Cache-Control: "no-store, no-cache, must-revalidate"
          Content-Type: "text/html"

         # permission: public-read